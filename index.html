
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>妈妈今天运动了吗</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="calc.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <h1>各式早餐</h1>
        <p>结账在页面的下方</p>
        <p id='prec'>肥肉保留小数点后几位？<input type="number" min=0 oninput="update_prec()" placeholder="默认0位"></p>
        <div style="overflow-x:auto;">
            <table id='atable'>
                <tr>
                    <th> 小笼包 </th>
                    <th> 单个热量 </th>
                    <th> 包数 </th>
                    <th> 总热量 </th>
                    <th> 脂肪系数 </th>
                    <th> 肥肉我不吃 </th>
                </tr>
                <tr>
                    <th> 普通心电图 </th>
                    <td id='calor'>13</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.10</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 心率变异性分析 </th>
                    <td id='calor'>26</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.11</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 心电图药物试验 </th>
                    <td id='calor'>39</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.11</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 频谱心电图 </th>
                    <td id='calor'>30</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.11</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 动态血压 </th>
                    <td id='calor'>182</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'> </td>
                    <td id='multi'>0.14</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 平板运动心电图 </th>
                    <td id='calor'>156</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.14</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 动态心电图（门诊）</th>
                    <td id='calor'>221</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.14</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 动态心电图（住院）</th>
                    <td id='calor'>156</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.14</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> 脑电图 </th>
                    <td id='calor'>100</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.13</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th> TCD </th>
                    <td id='calor'>118</td>
                    <td id='count'><input type="number" step="1" min=0 value=0></td>
                    <td id='total'></td>
                    <td id='multi'>0.13</td>
                    <td id='produ'></td>
                </tr>
                <tr>
                    <th id='bigh'> 总和 </th>
                    <td></td>
                    <td id='total_count'></td>
                    <td id='total_total'></td>
                    <td></td>
                    <td id='total_produ'></td>
                </tr>
            </table>
            <button type="button" onclick="main()" style="margin:15px">妈妈找我算账啦</button>
        </div>
    
        <!-- <p id='debug'> debug: </p> -->
    
    </body>

    <script>
        var IDS = ['calor', 'count', 'total', 'multi', 'produ'];
        var output_ids = ['total', 'produ'];

        function print(elt) {
            document.getElementById('debug').innerHTML += elt;
        }

        var prec = 0;
        function update_prec() {
            prec = document.getElementById('prec').getElementsByTagName('input')[0].value;
        }

        
        function row_to_obj(row) {
            obj = {}
            for(var col = 1; col < row.cells.length; ++col) {
                var entry = row.cells[col];
                var id = entry.getAttributeNode('id');
                if(!id || !entry.hasChildNodes()) continue;
                if(entry.firstChild instanceof HTMLInputElement) {
                    obj[id.value] = entry.getElementsByTagName('input')[0].value;
                } else {
                    obj[entry.getAttributeNode('id').value] = parseFloat(entry.innerHTML);
                }
            }
            return obj;
        }

        function fill_row(row, content) {
            for(var col = 1; col < row.cells.length; ++col) {
                var entry = row.cells[col];
                var id = entry.getAttributeNode('id');
                if(id && output_ids.includes(id.value)) {
                    row.cells[col].innerHTML = parseFloat(content[id.value]).toFixed(prec);
                }
            }
        }

        function main() {
            var atable = document.getElementById('atable');
            var total_count = 0;
            var total_total = 0;
            var total_produ = 0.;

            for(var row = 1; row < atable.rows.length - 1; ++row) {
                content = row_to_obj(atable.rows[row]);
                content['total'] = content['calor'] * content['count'];
                content['produ'] = content['total'] * content['multi'];
                fill_row(atable.rows[row], content);

                total_count += parseInt(content['count']);
                // print(' total_count' + total_count);
                total_total += parseInt(content['total']);
                total_produ += parseFloat(content['produ']);
            }
            document.getElementById('total_count').innerHTML = parseInt(total_count);
            document.getElementById('total_total').innerHTML = parseInt(total_total);
            document.getElementById('total_produ').innerHTML = parseFloat(total_produ).toFixed(prec);
        }
    </script>
</html>
